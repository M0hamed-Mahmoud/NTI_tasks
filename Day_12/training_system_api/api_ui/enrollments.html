<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Enrollments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Training System</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="students.html">Students</a></li>
            <li class="nav-item"><a class="nav-link" href="courses.html">Courses</a></li>
            <li class="nav-item"><a class="nav-link" href="enrollments.html">Enrollments</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- View Enrollments -->
      <div class="row d-flex justify-content-center">
        <div class="col-10">
          <h3 class="text-center my-3">Enrollments List</h3>
          <div class="row" id="enrollments"></div>
        </div>
      </div>
      <hr/>

      <!-- Create Enrollment Form -->
      <div class="row d-flex justify-content-center my-4">
        <div class="col-md-6">
          <h4>Create New Enrollment</h4>
          <form id="addEnrollmentForm" class="mb-4">
            <label>Student:</label>
            <select name="student_id" class="form-control mb-2" required></select>
            <label>Course:</label>
            <select name="course_id" class="form-control mb-2" required></select>
            <button type="submit" class="btn btn-success">Enroll Student</button>
          </form>
        </div>
      </div>
      <hr/>

      <!-- Edit/Delete Enrollment Form -->
      <div class="row d-flex justify-content-center my-4">
        <div class="col-md-6">
          <h4>Manage Existing Enrollment</h4>
            <label>Select Enrollment to Manage:</label>
            <select id="manage-enrollment-options" class="form-control mb-3" onchange="populateEditForm(this.value)"></select>

          <form id="editEnrollmentForm" class="mb-4" style="display:none;">
            <input type="hidden" name="id">
            <label>Student:</label>
            <select name="student_id" class="form-control mb-2" required></select>
            <label>Course:</label>
            <select name="course_id" class="form-control mb-2" required></select>
            <button type="submit" class="btn btn-primary">Update Enrollment</button>
            <button type="button" class="btn btn-danger" onclick="deleteEnrollment()">Delete Enrollment</button>
          </form>
        </div>
      </div>
    </div>

<script>
    const enrollmentsAPI = "http://localhost/session/day_10/training_system_api/enrollments_api/";
    const studentsAPI = "http://localhost/session/day_10/training_system_api/students_api/";
    const coursesAPI = "http://localhost/session/day_10/training_system_api/courses_api/";

    let allEnrollments = [];
    let allStudents = [];
    let allCourses = [];

    async function loadData() {
        // Fetch all data in parallel
        const [enrollRes, studentRes, courseRes] = await Promise.all([
            fetch(enrollmentsAPI),
            fetch(studentsAPI),
            fetch(coursesAPI)
        ]);

        allEnrollments = await enrollRes.json();
        allStudents = await studentRes.json();
        allCourses = await courseRes.json();

        displayEnrollments();
        populateDropdowns();
    }

    function displayEnrollments() {
        let html = "";
        if(allEnrollments.length === 0) {
            html = "<p class='text-center'>No enrollments found.</p>";
        } else {
            allEnrollments.forEach(enroll => {
                html += `<div class="col-md-6">
                    <div class="card shadow p-3 mb-3">
                        <p><strong>Student:</strong> ${enroll.student_name}</p>
                        <p><strong>Enrolled in:</strong> ${enroll.course_title}</p>
                        <small class="text-muted">Date: ${new Date(enroll.enrollment_date).toLocaleString()}</small>
                    </div>
                </div>`;
            });
        }
        document.getElementById("enrollments").innerHTML = html;
    }

    function populateDropdowns() {
        const studentSelectAdd = document.querySelector('#addEnrollmentForm select[name="student_id"]');
        const courseSelectAdd = document.querySelector('#addEnrollmentForm select[name="course_id"]');
        
        let studentOptions = '<option value="">Select a student</option>';
        allStudents.forEach(s => studentOptions += `<option value="${s.id}">${s.name}</option>`);
        
        let courseOptions = '<option value="">Select a course</option>';
        allCourses.forEach(c => courseOptions += `<option value="${c.id}">${c.title}</option>`);

        studentSelectAdd.innerHTML = studentOptions;
        courseSelectAdd.innerHTML = courseOptions;

        const manageSelect = document.getElementById('manage-enrollment-options');
        let manageOptions = '<option value="">Select an enrollment...</option>';
        allEnrollments.forEach(e => {
            manageOptions += `<option value="${e.id}">${e.student_name} - ${e.course_title}</option>`;
        });
        manageSelect.innerHTML = manageOptions;

        document.querySelector('#editEnrollmentForm select[name="student_id"]').innerHTML = studentOptions;
        document.querySelector('#editEnrollmentForm select[name="course_id"]').innerHTML = courseOptions;
    }

    function populateEditForm(enrollmentId) {
        const editForm = document.getElementById('editEnrollmentForm');
        if (!enrollmentId) {
            editForm.style.display = 'none';
            return;
        }
        
        const enrollment = allEnrollments.find(e => e.id == enrollmentId);
        editForm.querySelector('[name="id"]').value = enrollment.id;
        editForm.querySelector('[name="student_id"]').value = enrollment.student_id;
        editForm.querySelector('[name="course_id"]').value = enrollment.course_id;
        editForm.style.display = 'block';
    }
    
    document.getElementById("addEnrollmentForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const data = {
          student_id: e.target.student_id.value,
          course_id: e.target.course_id.value
        };
        fetch(enrollmentsAPI, {
          method: "POST", body: JSON.stringify(data)
        }).then(res => res.json()).then(res => {
          alert("‚úÖ " + res.message);
          loadData();
          e.target.reset();
        });
    });

    document.getElementById("editEnrollmentForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const data = {
            id: e.target.id.value,
            student_id: e.target.student_id.value,
            course_id: e.target.course_id.value
        };
        fetch(enrollmentsAPI, {
            method: "PUT", body: JSON.stringify(data)
        }).then(res => res.json()).then(res => {
            alert("üîÅ " + res.message);
            loadData();
            e.target.style.display = 'none';
        });
    });
    
    function deleteEnrollment() {
        const form = document.getElementById('editEnrollmentForm');
        const enrollmentId = form.querySelector('[name="id"]').value;
        if (!enrollmentId || !confirm("Are you sure you want to delete this enrollment?")) {
            return;
        }
        fetch(enrollmentsAPI, {
            method: "DELETE", body: JSON.stringify({ id: enrollmentId })
        }).then(res => res.json()).then(res => {
            alert("üóëÔ∏è " + res.message);
            loadData();
            form.style.display = 'none';
        });
    }

    // Initial Load
    loadData();
</script>

</body>
</html>