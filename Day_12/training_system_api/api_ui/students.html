<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Students</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Training System</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="students.html">Students</a></li>
            <li class="nav-item"><a class="nav-link" href="courses.html">Courses</a></li>
            <li class="nav-item"><a class="nav-link" href="enrollments.html">Enrollments</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- View Students -->
      <div class="row d-flex justify-content-center ">
        <div class="col-10">
          <h3 class="text-center my-3">Students List</h3>
          <div class="row" id="students"></div>
        </div>
      </div>
      <hr/>

      <!-- Add Student -->
      <div class="row d-flex justify-content-center my-4">
        <div class="col-md-6">
          <h4>Add New Student</h4>
          <form id="addStudentForm" class="mb-4">
            <input class="form-control mb-2" type="text" placeholder="Full Name" name="name" required>
            <input class="form-control mb-2" type="email" placeholder="Email" name="email" required>
            <input class="form-control mb-2" type="text" placeholder="Phone" name="phone">
            <button type="submit" class="btn btn-success">Add Student</button>
          </form>
        </div>
      </div>
      <hr/>
      
      <!-- Edit Student -->
      <div class="row d-flex justify-content-center my-4">
        <div class="col-md-6">
          <h4>Edit Student</h4>
          <select id="put-options" onchange="loadStudentForEdit(this.value)" class="form-control mb-2">
            <option value="">Select Student</option>
          </select>
    
          <form id="editStudentForm" class="mb-4">
            <div id="selected"></div>
            <input class="form-control mb-2" type="number" name="id" readonly required hidden>
            <input class="form-control mb-2" type="text" placeholder="New Name" name="name">
            <input class="form-control mb-2" type="email" placeholder="New Email" name="email">
            <input class="form-control mb-2" type="text" placeholder="New Phone" name="phone">
            <button type="submit" class="btn btn-primary">Update Student</button>
          </form>
        </div>
      </div>
      <hr/>

      <!-- Delete Student -->
      <div class="row d-flex justify-content-center my-4">
        <div class="col-md-6">
            <h4>Delete Student</h4>
            <form id="deleteStudentForm" class="mb-4">
                <select id="delete-student-options" class="form-control mb-2" name="id" required>
                    <option value="">Select Student to Delete</option>
                </select>
                <button type="submit" class="btn btn-danger">Delete Student</button>
            </form>
        </div>
      </div>
    </div>

    <script>
      const studentsAPI = "http://localhost/session/day_10/training_system_api/students_api/";
      
      function readAllStudents() {
        fetch(studentsAPI)
          .then(res => res.json())
          .then(data => {
            let html = "";
            let options = '<option value="">Select Student...</option>';
            data.forEach(student => {
              html += `<div class="col-md-4">
                <div class="card shadow p-3 mb-3">
                  <h5>${student.name}</h5>
                  <p>Email: ${student.email}</p>
                  <p>Phone: ${student.phone}</p>
                </div>
              </div>`;
              options += `<option value="${student.id}">${student.name}</option>`;
            });
            document.getElementById("students").innerHTML = html;
            document.getElementById("put-options").innerHTML = options;
            document.getElementById("delete-student-options").innerHTML = options;
          });
      }
      
      function loadStudentForEdit(id) {
          if (!id) return;
          fetch(studentsAPI + '?id=' + id)
            .then(res => res.json())
            .then(data => {
                const student = data[0];
                const theForm = document.getElementById("editStudentForm");
                theForm.querySelector('#selected').innerHTML = `<hr/>Editing: <strong><u>${student.name}</u></strong><hr/>`;
                theForm.querySelector('input[name="id"]').value = student.id;
                theForm.querySelector('input[name="name"]').value = student.name;
                theForm.querySelector('input[name="email"]').value = student.email;
                theForm.querySelector('input[name="phone"]').value = student.phone;
            });
      }

      readAllStudents();

      document.getElementById("addStudentForm").addEventListener("submit", function(e){
        e.preventDefault();
        const form = e.target;
        const data = {
          name: form.name.value,
          email: form.email.value,
          phone: form.phone.value
        };
        fetch(studentsAPI, {
          method: "POST",
          body: JSON.stringify(data)
        }).then(res => res.json()).then(res => {
          alert("‚úÖ " + res.message);
          readAllStudents();
          form.reset();
        });
      });

      document.getElementById("editStudentForm").addEventListener("submit", function(e){
        e.preventDefault();
        const form = e.target;
        const data = {
          id: form.id.value,
          name: form.name.value,
          email: form.email.value,
          phone: form.phone.value
        };
        fetch(studentsAPI, {
          method: "PUT",
          body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
          alert("üîÅ " + res.message);
          readAllStudents();
          form.reset();
          document.getElementById("selected").innerHTML = '';
        });
      });

      document.getElementById("deleteStudentForm").addEventListener("submit", function(e){
          e.preventDefault();
          if (!confirm("Are you sure? Deleting a student will also remove all their enrollments.")) {
              return;
          }
          const studentId = e.target.id.value;
          fetch(studentsAPI, {
              method: "DELETE",
              body: JSON.stringify({ id: studentId })
          }).then(res => res.json()).then(res => {
              alert("üóëÔ∏è " + res.message);
              readAllStudents();
              e.target.reset();
          });
      });
    </script>

</body>
</html>